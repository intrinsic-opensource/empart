# Copyright 2025 Intrinsic Innovation LLC

"""
End-to-end test for mobile merge functionality in the interactive viewer."""
import pytest
from playwright.sync_api import Page
import logging
logging.basicConfig(
    filename="playwright_console.log",  # path to your log file
    filemode="w",  # overwrite each run; use 'a' to append
    level=logging.INFO,  # capture info and above
    format="%(asctime)s %(levelname)s: %(message)s"
)
logger = logging.getLogger(__name__)
def test_recording(page: Page):
    page.set_viewport_size({'width': 1567, 'height': 894})
    logs: list[str] = []
    page.on("console", lambda m: logs.append(m.text))
    page.on("console", lambda m: print("[console]", m.text))
    page.goto("http://localhost:5004/?e2e", wait_until="domcontentloaded")
    page.wait_for_timeout(3000)  # initial settle
    page.mouse.move(116.976, 638.620)
    page.mouse.move(202.096, 794.574)
    page.mouse.move(8.429, 12.586)
    page.mouse.down()
    page.mouse.up()
    page.get_by_test_id("default-coarseness-slider-increment").click()
    page.mouse.move(8.429, 12.586)
    page.mouse.down()
    page.mouse.up()
    page.get_by_test_id("default-coarseness-slider-increment").click()
    page.mouse.move(213.919, 792.209)
    page.mouse.move(223.376, 773.294)
    page.mouse.move(239.927, 752.014)
    page.mouse.move(268.301, 709.454)
    page.mouse.move(317.954, 636.156)
    page.mouse.move(384.159, 543.943)
    page.mouse.move(544.941, 359.516)
    page.mouse.move(604.052, 312.227)
    page.mouse.move(700.994, 246.023)
    page.mouse.move(788.479, 203.463)
    page.mouse.move(894.879, 165.632)
    page.mouse.move(963.448, 144.352)
    page.mouse.move(1029.652, 127.801)
    page.mouse.move(1084.034, 111.250)
    page.mouse.move(1119.501, 99.427)
    page.mouse.move(1162.061, 85.241)
    page.mouse.move(1183.341, 78.147)
    page.mouse.move(1231.043, 71.054)
    page.mouse.move(1259.417, 71.054)
    page.mouse.move(1280.697, 71.054)
    page.mouse.move(1304.341, 71.054)
    page.mouse.move(1325.109, 71.054)
    page.mouse.move(8.484, 7.242)
    page.mouse.down()
    page.mouse.up()
    page.get_by_test_id("btn-run").click()
    if any("Hulls: 3" in t for t in logs):
            pass
    else:
        page.wait_for_event("console", lambda m: "Hulls: 3" in m.text, timeout=100_000)
    assert any("Hulls: 3" in t for t in logs)
    page.mouse.move(1337.857, 66.325)
    page.mouse.move(1315.651, 85.241)
    page.mouse.move(1294.371, 101.792)
    page.mouse.move(1273.091, 118.343)
    page.mouse.move(1237.624, 139.623)
    page.mouse.move(1197.429, 160.903)
    page.mouse.move(1164.326, 182.183)
    page.mouse.move(1117.038, 215.285)
    page.mouse.move(1079.206, 241.294)
    page.mouse.move(1020.095, 276.761)
    page.mouse.move(994.086, 293.312)
    page.mouse.move(975.171, 307.499)
    page.mouse.move(954.404, 316.956)
    page.mouse.move(909.479, 316.956)
    page.mouse.move(885.835, 316.956)
    page.mouse.move(856.535, 316.956)
    page.mouse.move(846.664, 309.863)
    page.mouse.down()
    page.mouse.up()
    page.wait_for_timeout(100)
    assert logs, 'no console logs captured'
    assert any("Selected hull → hull-nonSelect-0" in t for t in logs)
    page.mouse.move(846.664, 312.227)
    page.mouse.move(849.029, 344.817)
    page.mouse.move(844.300, 367.949)
    page.mouse.move(837.207, 399.613)
    page.mouse.move(832.478, 426.547)
    page.mouse.move(830.113, 450.192)
    page.mouse.move(830.113, 486.584)
    page.mouse.move(830.113, 518.248)
    page.mouse.move(827.749, 546.109)
    page.mouse.move(827.749, 564.512)
    page.mouse.down()
    page.mouse.up()
    page.wait_for_timeout(100)
    assert logs, 'no console logs captured'
    assert any("Selected hull → hull-nonSelect-2" in t for t in logs)
    page.mouse.move(824.458, 566.876)
    page.mouse.move(799.888, 571.605)
    page.mouse.move(759.693, 576.334)
    page.mouse.move(721.861, 578.698)
    page.mouse.move(686.395, 581.063)
    page.mouse.move(665.115, 583.427)
    page.mouse.move(598.497, 566.876)
    page.mouse.move(544.115, 559.783)
    page.mouse.move(485.004, 550.325)
    page.mouse.move(421.164, 540.867)
    page.mouse.move(350.230, 531.410)
    page.mouse.move(314.764, 526.681)
    page.mouse.move(286.390, 524.316)
    page.mouse.move(260.894, 529.045)
    page.mouse.move(237.250, 533.774)
    page.mouse.move(213.605, 538.503)
    page.mouse.move(180.503, 543.232)
    page.mouse.move(133.214, 550.325)
    page.mouse.move(111.934, 552.690)
    page.mouse.move(90.654, 555.054)
    page.mouse.move(67.010, 557.418)
    page.mouse.move(40.075, 562.147)
    page.mouse.move(21.159, 579.624)
    page.mouse.move(21.159, 601.317)
    page.mouse.move(38.636, 611.701)
    page.mouse.move(23.378, 12.602)
    page.mouse.down()
    page.mouse.up()
    prev_count = len(logs)
    page.get_by_test_id("merge-hulls-btn").click()
    page.wait_for_event("console", lambda m: "New stats →" in m.text, timeout=5000)
    page.wait_for_timeout(100)
    new_logs = logs[prev_count:]
    stats_msgs = [m for m in new_logs if 'New stats →' in m]
    assert len(stats_msgs) == 1, f"Expected 2 stats log, got {len(stats_msgs)}"
    page.mouse.move(44.291, 609.337)
    page.mouse.move(77.393, 590.421)
    page.mouse.move(119.953, 576.234)
    page.mouse.move(174.336, 559.683)
    page.mouse.move(216.896, 550.226)
    page.mouse.move(254.727, 540.768)
    page.mouse.move(302.016, 533.674)
    page.mouse.move(323.296, 531.310)
    page.mouse.move(350.131, 528.946)
    page.mouse.move(384.159, 526.581)
    page.mouse.move(440.906, 524.217)
    page.mouse.move(466.915, 524.217)
    page.mouse.move(502.382, 526.581)
    page.mouse.move(525.001, 545.497)
    page.mouse.move(563.758, 562.048)
    page.mouse.move(593.057, 571.505)
    page.mouse.move(636.543, 578.599)
    page.mouse.move(659.675, 583.328)
    page.mouse.move(696.993, 590.421)
    page.mouse.move(718.273, 592.785)
    page.mouse.move(772.656, 602.243)
    page.mouse.move(822.309, 611.701)
    page.mouse.move(862.504, 618.794)
    page.mouse.move(919.251, 628.252)
    page.mouse.move(959.446, 635.345)
    page.mouse.move(1020.922, 644.803)
    page.mouse.move(1051.660, 649.532)
    page.mouse.move(1072.940, 654.261)
    page.mouse.move(1077.669, 654.261)
    page.mouse.down()
    page.mouse.up()
    page.mouse.move(1077.7, 654.3)
    page.mouse.down()
    page.mouse.move(1154.2, 583.4, steps=5)
    page.mouse.up()
    page.mouse.move(1152.305, 583.427)
    page.mouse.move(1114.474, 583.427)
    page.mouse.move(1081.372, 583.427)
    page.mouse.move(1041.177, 583.427)
    page.mouse.move(967.879, 581.062)
    page.mouse.move(930.048, 581.062)
    page.mouse.move(885.123, 578.698)
    page.mouse.move(859.115, 578.698)
    page.mouse.move(833.106, 578.698)
    page.mouse.move(827.451, 550.325)
    page.mouse.move(827.451, 511.568)
    page.mouse.move(827.451, 479.904)
    page.mouse.move(827.451, 467.156)
    page.mouse.down()
    page.mouse.up()
    page.wait_for_timeout(100)
    assert logs, 'no console logs captured'
    assert any("Selected hull → hull-nonSelect-1" in t for t in logs)
    page.mouse.move(825.086, 469.520)
    page.mouse.move(801.442, 481.656)
    page.mouse.move(784.891, 493.892)
    page.mouse.move(778.823, 513.733)
    page.mouse.move(762.272, 527.920)
    page.mouse.move(738.627, 545.397)
    page.mouse.move(722.076, 565.238)
    page.mouse.move(710.254, 584.154)
    page.mouse.move(707.890, 588.883)
    page.mouse.down()
    page.mouse.up()
    page.wait_for_timeout(100)
    assert logs, 'no console logs captured'
    assert any("Selected hull → hull-nonSelect-0" in t for t in logs)
    page.mouse.move(703.161, 588.883)
    page.mouse.move(677.152, 591.247)
    page.mouse.move(641.685, 591.247)
    page.mouse.move(601.490, 591.247)
    page.mouse.move(532.921, 586.518)
    page.mouse.move(485.632, 584.154)
    page.mouse.move(454.894, 584.154)
    page.mouse.move(431.250, 581.789)
    page.mouse.move(405.753, 581.789)
    page.mouse.move(382.109, 581.789)
    page.mouse.move(356.100, 581.789)
    page.mouse.move(327.727, 581.789)
    page.mouse.move(280.438, 581.789)
    page.mouse.move(249.700, 579.425)
    page.mouse.move(216.598, 577.060)
    page.mouse.move(176.402, 574.696)
    page.mouse.move(145.665, 572.332)
    page.mouse.move(122.533, 572.332)
    page.mouse.move(100.839, 579.425)
    page.mouse.move(77.195, 595.976)
    page.mouse.move(63.008, 611.088)
    page.mouse.move(43.021, 11.989)
    page.mouse.down()
    page.mouse.up()
    prev_count = len(logs)
    page.get_by_test_id("merge-hulls-btn").click()    
    page.wait_for_event("console", lambda m: "New stats →" in m.text, timeout=5000)
    page.wait_for_timeout(100)
    new_logs = logs[prev_count:]
    stats_msgs = [m for m in new_logs if 'New stats →' in m]
    assert len(stats_msgs) == 1, f"Expected 1 stats log, got {len(stats_msgs)}"
    page.mouse.move(65.373, 608.724)
    page.mouse.move(103.204, 592.173)
    page.mouse.move(136.306, 580.351)
    page.mouse.move(164.679, 568.529)
    page.mouse.move(197.782, 556.706)
    page.mouse.move(242.706, 537.791)
    page.mouse.move(263.473, 525.969)
    page.mouse.move(294.211, 518.875)
    page.mouse.move(323.510, 518.875)
    page.mouse.move(300.792, 554.342)
    page.mouse.move(251.139, 606.360)
    page.mouse.move(213.307, 644.191)
    page.mouse.move(168.383, 689.115)
    page.mouse.move(140.010, 717.489)
    page.mouse.move(123.459, 736.404)
    page.mouse.move(114.001, 759.949)
    page.mouse.move(102.179, 780.204)
    page.mouse.move(87.992, 803.336)
    page.mouse.move(76.170, 820.813)
    page.mouse.move(64.347, 837.364)
    page.mouse.move(34.892, 6.444)
    page.mouse.down()
    page.mouse.up()
